<!doctype html>
<html>

<head>
    <title>{{ .Title }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin: 20px 0;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        #spring-list {
            list-style: none;
            padding: 0;
        }

        #spring-list li {
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        #spring-list a {
            text-decoration: none;
            color: #007acc;
            font-weight: bold;
        }

        .location-controls {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .location-btn {
            background: #007acc;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .location-btn:hover {
            background: #005a99;
        }

        .location-status {
            margin-top: 10px;
            font-style: italic;
        }

        .distance-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        #radius-control {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
        }

        #radius-slider {
            width: 200px;
            margin: 0 10px;
        }

        .map-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-toggle {
            background: #6c757d;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .map-toggle:hover {
            background: #5a6268;
        }

        .map-toggle.active {
            background: #007acc;
        }

        .cluster-icon {
            background: #007acc;
            border: 2px solid #fff;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cluster-icon-small {
            width: 30px;
            height: 30px;
            line-height: 26px;
            font-size: 12px;
        }

        .cluster-icon-medium {
            width: 40px;
            height: 40px;
            line-height: 36px;
            font-size: 14px;
        }

        .cluster-icon-large {
            width: 50px;
            height: 50px;
            line-height: 46px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>{{ .Title }}</h1>
    {{ .Content }}

    <div class="location-controls">
        <h3>Filter by Distance</h3>
        <button class="location-btn" onclick="getMyLocation()">üìç Use My Location</button>
        <div id="location-status" class="location-status"></div>
        <div id="radius-control" style="display: none;">
            <label>Show springs within: <input type="range" id="radius-slider" min="10" max="200" value="100"
                    oninput="updateRadius()"> <span id="radius-value">100</span> miles</label>
        </div>
    </div>

    <div class="map-controls">
        <span><strong>Map View:</strong></span>
        <button class="map-toggle active" id="markers-btn" onclick="toggleMapMode('markers')">üìç Individual
            Markers</button>
        <button class="map-toggle" id="clusters-btn" onclick="toggleMapMode('clusters')">üîó Clustered View</button>
        <button class="map-toggle" id="heatmap-btn" onclick="toggleMapMode('heatmap')">üî• Heat Map</button>
        <span style="margin-left: auto; font-size: 0.9em; color: #666;">
            Showing <span id="marker-count">0</span> hot springs
        </span>
    </div>

    <h2>Interactive Map</h2>
    <div id="map"></div>

    <h2>Hot Springs Directory</h2>
    <ul id="spring-list">
        {{ range .Site.Data.springs }}
        <li><a href="/springs/{{ .slug }}/">{{ .name }} Hot Springs</a> - {{ .temp_f }}¬∞F, ${{ .fee }}</li>
        {{ end }}
    </ul>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script>
        let map;
        let springs = [];
        let userLocation = null;
        let userMarker = null;
        let springMarkers = [];
        let markerClusterGroup = null;
        let heatmapLayer = null;
        let currentMapMode = 'markers';

        // Initialize map and load springs data
        fetch('/springs/index.json')
            .then(r => r.json())
            .then(data => {
                springs = data;
                map = L.map('map').setView([47.5, -120.5], 7);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Initialize cluster group with custom styling
                markerClusterGroup = L.markerClusterGroup({
                    iconCreateFunction: function (cluster) {
                        const count = cluster.getChildCount();
                        let size = 'small';
                        if (count >= 10) size = 'large';
                        else if (count >= 5) size = 'medium';

                        return L.divIcon({
                            html: count,
                            className: `cluster-icon cluster-icon-${size}`,
                            iconSize: null
                        });
                    },
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true,
                    maxClusterRadius: 50
                });

                displaySprings();
            });

        function displaySprings() {
            // Clear existing layers
            clearAllLayers();

            const filteredSprings = [];
            const heatmapData = [];

            springs.forEach(s => {
                const coords = s.gps.match(/([\d.]+)¬∞\s*N,\s*([\d.]+)¬∞\s*W/);
                if (coords) {
                    const lat = parseFloat(coords[1]);
                    const lng = -parseFloat(coords[2]);
                    s.lat = lat;
                    s.lng = lng;

                    // Check if within radius filter
                    if (userLocation) {
                        const distance = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
                        const maxRadius = parseInt(document.getElementById('radius-slider').value);
                        if (distance > maxRadius) return; // Skip if outside radius
                        s.distance = distance;
                    }

                    // Create marker
                    const marker = L.marker([lat, lng]);
                    let popupContent = `<b>${s.name} Hot Springs</b><br>${s.temp_f}¬∞F ‚Äì $${s.fee}<br><a href="/springs/${s.slug}/">View Details & Directions</a>`;

                    if (s.distance) {
                        popupContent = `<b>${s.name} Hot Springs</b><br>${s.temp_f}¬∞F ‚Äì $${s.fee}<br><strong>${s.distance.toFixed(1)} miles away</strong><br><a href="/springs/${s.slug}/">View Details & Directions</a>`;
                    }

                    marker.bindPopup(popupContent);
                    filteredSprings.push({ spring: s, marker: marker });

                    // Add to heatmap data (intensity based on temperature)
                    const intensity = Math.max(0.3, s.temp_f / 120); // Normalize temperature to 0.3-1.0
                    heatmapData.push([lat, lng, intensity]);
                }
            });

            // Update marker count
            document.getElementById('marker-count').textContent = filteredSprings.length;

            // Display based on current mode
            if (currentMapMode === 'markers') {
                filteredSprings.forEach(item => {
                    item.marker.addTo(map);
                    springMarkers.push(item.marker);
                });
            } else if (currentMapMode === 'clusters') {
                filteredSprings.forEach(item => {
                    markerClusterGroup.addLayer(item.marker);
                });
                map.addLayer(markerClusterGroup);
            } else if (currentMapMode === 'heatmap') {
                if (heatmapData.length > 0) {
                    heatmapLayer = L.heatLayer(heatmapData, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 17,
                        gradient: {
                            0.0: '#3388ff',
                            0.5: '#ffaa00',
                            1.0: '#ff0000'
                        }
                    }).addTo(map);
                }
            }

            updateSpringsList();
        }

        function clearAllLayers() {
            // Clear individual markers
            springMarkers.forEach(marker => map.removeLayer(marker));
            springMarkers = [];

            // Clear cluster group
            if (markerClusterGroup) {
                markerClusterGroup.clearLayers();
                map.removeLayer(markerClusterGroup);
            }

            // Clear heatmap
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
        }

        function toggleMapMode(mode) {
            currentMapMode = mode;

            // Update button states
            document.querySelectorAll('.map-toggle').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + '-btn').classList.add('active');

            // Redisplay springs with new mode
            displaySprings();
        }

        function getMyLocation() {
            const status = document.getElementById('location-status');
            status.textContent = 'Getting your location...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        status.textContent = `‚úÖ Location found! Use slider to filter by distance.`;
                        document.getElementById('radius-control').style.display = 'block';
                        addUserLocationToMap();
                        displaySprings();
                    },
                    (error) => {
                        let errorMsg = '‚ùå Could not get your location. ';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += 'Location permission denied. Please enable location access in your browser settings.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += 'Location unavailable.';
                                break;
                            case error.TIMEOUT:
                                errorMsg += 'Request timed out.';
                                break;
                            default:
                                errorMsg += 'Unknown error.';
                        }
                        
                        status.textContent = errorMsg;
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                status.textContent = '‚ùå Geolocation not supported by your browser.';
            }
        }

        function addUserLocationToMap() {
            if (userMarker) map.removeLayer(userMarker);

            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo=',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            userMarker.bindPopup('<b>üìç Your Location</b>');
        }

        function updateRadius() {
            const radius = document.getElementById('radius-slider').value;
            document.getElementById('radius-value').textContent = radius;
            if (userLocation) {
                displaySprings();
            }
        }

        function updateSpringsList() {
            const filteredSprings = springs.filter(s => {
                if (!userLocation) return true;
                return s.distance !== undefined; // Only show springs that passed the radius filter
            }).sort((a, b) => (a.distance || 0) - (b.distance || 0));

            const listElement = document.getElementById('spring-list');
            listElement.innerHTML = filteredSprings.map(s => {
                let html = `<li><a href="/springs/${s.slug}/">${s.name} Hot Springs</a> - ${s.temp_f}¬∞F, $${s.fee}`;
                if (s.distance) {
                    html += `<div class="distance-info">üìç ${s.distance.toFixed(1)} miles away</div>`;
                }
                html += '</li>';
                return html;
            }).join('');
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    </script>
</body>

</html>