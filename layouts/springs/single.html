<!doctype html>
<html>
<head>
    <title>{{ .Title }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        #map { height: 400px; width: 100%; margin: 20px 0; border-radius: 8px; }
        .spring-header { background: linear-gradient(135deg, #e8f4f8, #f0f8ff); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .spring-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f9f9f9; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #007acc; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        .directions-section { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .directions-btn { background: #007acc; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; text-decoration: none; display: inline-block; }
        .directions-btn:hover { background: #005a99; }
        .distance-display { background: #d4edda; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .back-link { color: #007acc; text-decoration: none; margin-bottom: 20px; display: inline-block; }
        .back-link:hover { text-decoration: underline; }
        .widget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .widget-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007acc; }
        .widget-card h4 { margin-top: 0; color: #007acc; }
        .weather-current { font-size: 1.2em; font-weight: bold; margin: 10px 0; }
        .pack-list { list-style: none; padding: 0; }
        .pack-list li { padding: 5px 0; }
        .pack-list li:before { content: "‚úì "; color: #28a745; font-weight: bold; }
        .sun-times { display: flex; justify-content: space-between; margin: 10px 0; }
        .gps-copy { background: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .gps-copy:hover { background: #5a6268; }
        .forecast-strip { display: flex; gap: 10px; overflow-x: auto; margin: 15px 0; padding: 10px 0; }
        .forecast-day { min-width: 80px; text-align: center; padding: 10px; background: #fff; border-radius: 6px; border: 1px solid #dee2e6; }
        .forecast-day-name { font-weight: bold; font-size: 0.9em; color: #666; }
        .forecast-temp { font-size: 1.1em; color: #007acc; margin: 5px 0; }
        .forecast-icon { font-size: 1.5em; margin: 5px 0; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .action-btn { background: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 0.9em; }
        .action-btn:hover { background: #218838; }
        .action-btn.secondary { background: #6c757d; }
        .action-btn.secondary:hover { background: #5a6268; }
    </style>
</head>
<body>
    <a href="/springs/" class="back-link">‚Üê Back to All Hot Springs</a>
    
    <div class="spring-header">
        <h1>{{ .Params.name }} Hot Springs</h1>
        <p>{{ .Params.description }}</p>
    </div>

    <div class="spring-stats">
        <div class="stat-box">
            <div class="stat-value">{{ .Params.temp_f }}¬∞F</div>
            <div class="stat-label">Temperature</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${{ .Params.fee }}</div>
            <div class="stat-label">Entry Fee</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="distance-value">-</div>
            <div class="stat-label">Distance from You</div>
        </div>
    </div>

    <div class="directions-section">
        <h3>üöó Get Directions</h3>
        
        <div id="location-status-banner" style="display: none; background: #e7f3ff; border-left: 4px solid #007acc; padding: 12px; margin-bottom: 15px; border-radius: 4px; font-size: 0.95em;">
            <span id="status-text"></span>
        </div>
        
        <div id="button-group" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <button class="directions-btn" onclick="getMyLocationForDirections()" id="gps-btn">üìç Use My Current Location</button>
            <button class="directions-btn" onclick="showAddressInput()" id="manual-btn">‚úèÔ∏è Enter Address Manually</button>
        </div>
        
        <div id="address-input-section" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Where are you starting from?</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="start-address" placeholder="e.g., Seattle, WA or 123 Main St" style="padding: 10px; flex: 1; min-width: 250px; border: 1px solid #ddd; border-radius: 4px;">
                <button class="directions-btn" onclick="calculateDirections()" style="background: #28a745;">Get Directions</button>
            </div>
        </div>
        
        <div id="distance-info" class="distance-display" style="display: none;">
            <strong>üìç Distance:</strong> <span id="calculated-distance">-</span> miles
            <br><strong>‚è±Ô∏è Estimated Drive Time:</strong> <span id="drive-time">-</span>
        </div>
        
        <div id="directions-links" style="margin-top: 15px; display: none; display: flex; gap: 10px; flex-wrap: wrap;">
            <a id="google-maps-link" class="directions-btn" target="_blank" style="background: #4285f4;">üó∫Ô∏è Google Maps</a>
            <a id="apple-maps-link" class="directions-btn" target="_blank" style="background: #555;">üçé Apple Maps</a>
            <a id="waze-link" class="directions-btn" target="_blank" style="background: #00d4ff; color: #000;">üöó Waze</a>
        </div>
    </div>

    <div class="widget-grid">
        <div class="widget-card">
            <h4>üå§Ô∏è Weather Forecast</h4>
            <div id="weather-card">Loading weather...</div>
            <div id="sun-times" class="sun-times">
                <span id="sunrise">üåÖ Loading...</span>
                <span id="sunset">üåá Loading...</span>
            </div>
            <div id="forecast-strip" class="forecast-strip">
                <div style="text-align: center; width: 100%; color: #999;">Loading 7-day forecast...</div>
            </div>
        </div>
        
        <div class="widget-card">
            <h4>üéí What to Pack</h4>
            <ul id="pack-list" class="pack-list">
                <li>Loading recommendations...</li>
            </ul>
            <div id="crowd-estimate" style="margin-top: 15px; font-style: italic;"></div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="action-btn" onclick="saveToCalendar()">üìÖ Add to Calendar</button>
        <button class="action-btn secondary" onclick="reportStatus()">üìù Report Status/Conditions</button>
    </div>

    <h3>üìç Location & Map</h3>
    <div id="map"></div>
    <p><strong>GPS Coordinates:</strong> {{ .Params.gps }} 
        <button class="gps-copy" onclick="copyGPS()">üìã Copy GPS</button>
    </p>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Overpass API configuration
        const OVERPASS_URL = 'https://overpass-api.de/api/interpreter';
        const RADIUS_METERS = 16093; // 10 miles
        
        // Category definitions with colors and icons
        const CATEGORIES = {
            restaurants: {
                name: 'Restaurants',
                color: '#ff6b6b',
                icon: 'üçΩÔ∏è',
                query: '[out:json];(node[amenity=restaurant](around:{RADIUS},{lat},{lng});way[amenity=restaurant](around:{RADIUS},{lat},{lng});node[amenity=cafe](around:{RADIUS},{lat},{lng});way[amenity=cafe](around:{RADIUS},{lat},{lng}););out center;'
            },
            trails: {
                name: 'Trails',
                color: '#4ecdc4',
                icon: 'ü•æ',
                query: '[out:json];(node[route=hiking](around:{RADIUS},{lat},{lng});way[route=hiking](around:{RADIUS},{lat},{lng});node[highway=path][sac_scale](around:{RADIUS},{lat},{lng});way[highway=path][sac_scale](around:{RADIUS},{lat},{lng}););out center;'
            },
            gas: {
                name: 'Gas Stations',
                color: '#f7b731',
                icon: '‚õΩ',
                query: '[out:json];(node[amenity=fuel](around:{RADIUS},{lat},{lng});way[amenity=fuel](around:{RADIUS},{lat},{lng}););out center;'
            },
            campgrounds: {
                name: 'Campgrounds',
                color: '#95e77e',
                icon: 'üèïÔ∏è',
                query: '[out:json];(node[tourism=camp_site](around:{RADIUS},{lat},{lng});way[tourism=camp_site](around:{RADIUS},{lat},{lng}););out center;'
            }
        };
        
        // Overpass API integration
        class NearbyAttractions {
            constructor(map, centerLat, centerLng) {
                this.map = map;
                this.centerLat = centerLat;
                this.centerLng = centerLng;
                this.layers = {};
                this.layerGroup = L.layerGroup().addTo(map);
                this.controlAdded = false;
            }
            
            async fetchCategory(category) {
                const query = CATEGORIES[category].query
                    .replace(/{RADIUS}/g, RADIUS_METERS)
                    .replace(/{lat}/g, this.centerLat)
                    .replace(/{lng}/g, this.centerLng);
                
                try {
                    const response = await fetch(OVERPASS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `data=${encodeURIComponent(query)}`
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return this.processResults(data.elements, category);
                } catch (error) {
                    console.error(`Error fetching ${category}:`, error);
                    return [];
                }
            }
            
            processResults(elements, category) {
                return elements
                    .filter(element => element.tags && element.tags.name)
                    .map(element => {
                        const lat = element.lat || (element.center && element.center.lat);
                        const lng = element.lon || (element.center && element.center.lon);
                        const distance = this.calculateDistance(lat, lng);
                        
                        return {
                            id: element.id,
                            name: element.tags.name,
                            lat: lat,
                            lng: lng,
                            distance: distance,
                            category: category,
                            type: this.getTypeFromTags(element.tags),
                            tags: element.tags
                        };
                    })
                    .sort((a, b) => a.distance - b.distance) // Sort by distance
                    .slice(0, 20); // Limit to 20 closest
            }
            
            calculateDistance(lat, lng) {
                const R = 3959; // Earth's radius in miles
                const dLat = (lat - this.centerLat) * Math.PI / 180;
                const dLng = (lng - this.centerLng) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(this.centerLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                          Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            getTypeFromTags(tags) {
                if (tags.amenity === 'restaurant' || tags.amenity === 'cafe') return 'Restaurant';
                if (tags.amenity === 'fuel') return 'Gas Station';
                if (tags.tourism === 'camp_site') return 'Campground';
                if (tags.route === 'hiking' || tags.sac_scale) return 'Hiking Trail';
                return 'Point of Interest';
            }
            
            createPopupHTML(attraction) {
                const categoryKey = attraction.category;
                const category = CATEGORIES[categoryKey];
                const googleMapsUrl = `https://www.google.com/maps/dir/${this.centerLat},${this.centerLng}/${attraction.lat},${attraction.lng}`;
                
                return `
                    <div style="font-family: Arial, sans-serif; line-height: 1.4;">
                        <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${category.color};">
                            ${category.icon} ${attraction.name}
                        </div>
                        <div style="color: #666; margin-bottom: 8px;">
                            ${attraction.type} ‚Ä¢ ${attraction.distance.toFixed(1)} miles away
                        </div>
                        <div style="margin-top: 10px;">
                            <a href="${googleMapsUrl}" target="_blank" style="background: #4285f4; color: white; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 0.9em; display: inline-block;">
                                üó∫Ô∏è Get Directions
                            </a>
                        </div>
                    </div>
                `;
            }
            
            createMarker(attraction) {
                const category = CATEGORIES[attraction.category];
                
                // Create colored marker icon
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div style="
                            background: ${category.color};
                            width: 30px;
                            height: 30px;
                            border-radius: 50% 50% 50% 0;
                            transform: rotate(-45deg);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        ">
                            <span style="
                                transform: rotate(45deg);
                                color: white;
                                font-size: 16px;
                                line-height: 1;
                            ">${category.icon}</span>
                        </div>
                    `,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });
                
                const marker = L.marker([attraction.lat, attraction.lng], {
                    icon: markerIcon
                }).bindPopup(this.createPopupHTML(attraction));
                
                return marker;
            }
            
            async loadAllCategories() {
                console.log('üìç Loading nearby attractions...');
                
                for (const [key, category] of Object.entries(CATEGORIES)) {
                    const attractions = await this.fetchCategory(key);
                    
                    if (attractions.length > 0) {
                        const markers = attractions.map(a => this.createMarker(a));
                        this.layers[key] = L.layerGroup(markers);
                    }
                }
                
                this.addLayerControl();
            }
            
            addLayerControl() {
                if (this.controlAdded) return;
                
                const overlayMaps = {};
                for (const [key, category] of Object.entries(CATEGORIES)) {
                    if (this.layers[key]) {
                        overlayMaps[category.name] = this.layers[key];
                    }
                }
                
                // Add layer control
                L.control.layers(null, overlayMaps, {
                    collapsed: false,
                    position: 'topright'
                }).addTo(this.map);
                
                this.controlAdded = true;
                
                // Add instructions
                const instructions = document.createElement('div');
                instructions.innerHTML = `
                    <div style="background: rgba(255,255,255,0.9); padding: 8px 12px; margin-top: 10px; border-radius: 4px; font-size: 0.85em; color: #666;">
                        üìç Click categories above to toggle nearby attractions
                    </div>
                `;
                document.querySelector('.leaflet-control-layers').appendChild(instructions);
            }
        }
        // Parse GPS coordinates
        const gpsString = "{{ .Params.gps }}";
        const coords = gpsString.match(/([\d.]+)¬∞\s*N,\s*([\d.]+)¬∞\s*W/);
        let springLat, springLng;
        let userLocation = null;
        
        if (coords) {
            springLat = parseFloat(coords[1]);
            springLng = -parseFloat(coords[2]); // West is negative
            
            // Create map
            const map = L.map('map').setView([springLat, springLng], 13);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add marker for hot spring
            L.marker([springLat, springLng])
                .addTo(map)
                .bindPopup('<b>{{ .Params.name }} Hot Springs</b><br>{{ .Params.temp_f }}¬∞F - ${{ .Params.fee }}')
                .openPopup();
        }

        function getMyLocationForDirections() {
            const statusBanner = document.getElementById('location-status-banner');
            const statusText = document.getElementById('status-text');
            
            if (navigator.geolocation) {
                statusText.textContent = 'üìç Getting your location...';
                statusBanner.style.display = 'block';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        statusText.textContent = '‚úÖ Location found! Calculating directions...';
                        calculateAndDisplayDirections();
                    },
                    (error) => {
                        let statusMsg = '';
                        let showAddressForm = false;
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                statusMsg = 'üìç Location permission denied. No problem! Enter your address below instead.';
                                showAddressForm = true;
                                break;
                            case error.POSITION_UNAVAILABLE:
                                statusMsg = 'üìç Location unavailable. Please enter your address below.';
                                showAddressForm = true;
                                break;
                            case error.TIMEOUT:
                                statusMsg = 'üìç Location request timed out. Please enter your address below.';
                                showAddressForm = true;
                                break;
                            default:
                                statusMsg = 'üìç Could not get location. Please enter your address below.';
                                showAddressForm = true;
                        }
                        
                        statusText.textContent = statusMsg;
                        statusBanner.style.background = '#fff3cd';
                        statusBanner.style.borderLeftColor = '#ffc107';
                        
                        if (showAddressForm) {
                            setTimeout(() => {
                                showAddressInput();
                            }, 500);
                        }
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                statusText.textContent = 'üìç Geolocation not supported. Please enter your address below.';
                statusBanner.style.background = '#fff3cd';
                statusBanner.style.borderLeftColor = '#ffc107';
                statusBanner.style.display = 'block';
                showAddressInput();
            }
        }

        function showAddressInput() {
            document.getElementById('address-input-section').style.display = 'block';
            document.getElementById('start-address').focus();
        }

        function calculateDirections() {
            const address = document.getElementById('start-address').value;
            if (!address) {
                alert('Please enter a starting address.');
                return;
            }

            // Geocode the address
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        userLocation = {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon)
                        };
                        
                        calculateAndDisplayDirections();
                    } else {
                        alert('Address not found. Please try a different address.');
                    }
                })
                .catch(error => {
                    alert('Error looking up address.');
                });
        }

        function calculateAndDisplayDirections() {
            if (!userLocation || !springLat || !springLng) return;

            // Calculate distance
            const distance = calculateDistance(userLocation.lat, userLocation.lng, springLat, springLng);
            
            // Estimate drive time (assuming average 45 mph including stops)
            const driveTimeHours = distance / 45;
            const hours = Math.floor(driveTimeHours);
            const minutes = Math.round((driveTimeHours - hours) * 60);
            const driveTimeText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            // Update display
            document.getElementById('calculated-distance').textContent = distance.toFixed(1);
            document.getElementById('drive-time').textContent = driveTimeText;
            document.getElementById('distance-value').textContent = distance.toFixed(1) + ' mi';
            document.getElementById('distance-info').style.display = 'block';
            document.getElementById('directions-links').style.display = 'block';

            // Update direction links
            const googleUrl = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lng}/${springLat},${springLng}`;
            const appleUrl = `http://maps.apple.com/?saddr=${userLocation.lat},${userLocation.lng}&daddr=${springLat},${springLng}`;
            const wazeUrl = `https://waze.com/ul?ll=${springLat},${springLng}&navigate=yes&from=${userLocation.lat},${userLocation.lng}`;

            document.getElementById('google-maps-link').href = googleUrl;
            document.getElementById('apple-maps-link').href = appleUrl;
            document.getElementById('waze-link').href = wazeUrl;

            // Add user location to map
            if (window.map) {
                const userMarker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo=',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(window.map);

                userMarker.bindPopup('<b>üìç Your Location</b>');

                // Fit map to show both locations
                const group = new L.featureGroup([
                    L.marker([springLat, springLng]),
                    userMarker
                ]);
                window.map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Store map reference globally
        if (coords) {
            window.map = map;
            
            // Load weather and other widgets
            loadWeather(springLat, springLng);
            load7DayForecast(springLat, springLng);
            loadSunTimes(springLat, springLng);
            generatePackingList();
            estimateCrowd();
        }

        // Weather widget
        function loadWeather(lat, lng) {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,precipitation,weather_code,wind_speed_10m&temperature_unit=fahrenheit&timezone=auto`)
                .then(r => r.json())
                .then(d => {
                    const temp = Math.round(d.current.temperature_2m);
                    const precip = d.current.precipitation;
                    const wind = Math.round(d.current.wind_speed_10m);
                    const weatherCode = d.current.weather_code;
                    
                    // Simple weather code interpretation
                    let condition = 'Clear';
                    if (weatherCode >= 80) condition = 'Rainy';
                    else if (weatherCode >= 61) condition = 'Light Rain';
                    else if (weatherCode >= 51) condition = 'Drizzle';
                    else if (weatherCode >= 45) condition = 'Foggy';
                    else if (weatherCode >= 20) condition = 'Cloudy';
                    
                    document.getElementById('weather-card').innerHTML = `
                        <div class="weather-current">${temp}¬∞F - ${condition}</div>
                        <div>üí® Wind: ${wind} mph | üåßÔ∏è Precip: ${precip}" today</div>
                    `;
                })
                .catch(() => {
                    document.getElementById('weather-card').innerHTML = 'Weather unavailable';
                });
        }

        // Sunrise/sunset widget
        function loadSunTimes(lat, lng) {
            fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`)
                .then(r => r.json())
                .then(d => {
                    const sunrise = new Date(d.results.sunrise).toLocaleTimeString([], {timeStyle: 'short'});
                    const sunset = new Date(d.results.sunset).toLocaleTimeString([], {timeStyle: 'short'});
                    
                    document.getElementById('sunrise').textContent = `üåÖ ${sunrise}`;
                    document.getElementById('sunset').textContent = `üåá ${sunset}`;
                })
                .catch(() => {
                    document.getElementById('sunrise').textContent = 'üåÖ Sunrise: --';
                    document.getElementById('sunset').textContent = 'üåá Sunset: --';
                });
        }

        // Smart packing list based on season and conditions
        function generatePackingList() {
            const month = new Date().getMonth() + 1;
            const isWinter = month <= 3 || month >= 11;
            const isSummer = month >= 6 && month <= 8;
            
            let packItems = ['Swimsuit', 'Towel', 'Water bottle', 'Snacks'];
            
            if (isWinter) {
                packItems.push('Warm clothes', 'Waterproof boots', 'Hand warmers');
            } else if (isSummer) {
                packItems.push('Sunscreen', 'Hat', 'Sandals');
            } else {
                packItems.push('Light jacket', 'Comfortable shoes');
            }
            
            // Add fee-specific items
            if ({{ .Params.fee }} > 0) {
                packItems.push('Cash for entry fee');
            }
            
            document.getElementById('pack-list').innerHTML = packItems.map(item => `<li>${item}</li>`).join('');
        }

        // Crowd estimation
        function estimateCrowd() {
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday
            const hour = now.getHours();
            const isWeekend = (day === 0 || day === 6);
            const isFree = {{ .Params.fee }} === 0;
            
            let crowdLevel = 'Quiet';
            let crowdColor = '#28a745';
            
            if (isWeekend && isFree) {
                crowdLevel = 'Likely Busy';
                crowdColor = '#ffc107';
            } else if (isWeekend || (hour >= 10 && hour <= 16)) {
                crowdLevel = 'Moderate';
                crowdColor = '#17a2b8';
            }
            
            document.getElementById('crowd-estimate').innerHTML = `
                <span style="color: ${crowdColor};">üìä Expected crowd: ${crowdLevel}</span>
            `;
        }

        // 7-Day Forecast
        function load7DayForecast(lat, lng) {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weather_code&temperature_unit=fahrenheit&timezone=auto`)
                .then(r => r.json())
                .then(d => {
                    const forecastHTML = d.daily.time.slice(0, 7).map((date, i) => {
                        const dayName = new Date(date).toLocaleDateString('en-US', { weekday: 'short' });
                        const maxTemp = Math.round(d.daily.temperature_2m_max[i]);
                        const minTemp = Math.round(d.daily.temperature_2m_min[i]);
                        const precip = d.daily.precipitation_sum[i];
                        const weatherCode = d.daily.weather_code[i];
                        
                        // Weather icon based on code
                        let icon = '‚òÄÔ∏è';
                        if (weatherCode >= 80) icon = 'üåßÔ∏è';
                        else if (weatherCode >= 61) icon = 'üå¶Ô∏è';
                        else if (weatherCode >= 51) icon = 'üåßÔ∏è';
                        else if (weatherCode >= 45) icon = 'üå´Ô∏è';
                        else if (weatherCode >= 20) icon = '‚òÅÔ∏è';
                        
                        return `
                            <div class="forecast-day">
                                <div class="forecast-day-name">${dayName}</div>
                                <div class="forecast-icon">${icon}</div>
                                <div class="forecast-temp">${maxTemp}¬∞/${minTemp}¬∞</div>
                                <div style="font-size: 0.8em; color: #666;">${precip > 0 ? precip + '"' : 'Dry'}</div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('forecast-strip').innerHTML = forecastHTML;
                })
                .catch(() => {
                    document.getElementById('forecast-strip').innerHTML = '<div style="text-align: center; width: 100%; color: #999;">Forecast unavailable</div>';
                });
        }

        // Save to Calendar (.ics file)
        function saveToCalendar() {
            const springName = "{{ .Params.name }} Hot Springs";
            const gps = "{{ .Params.gps }}";
            const description = "{{ .Params.description }}";
            const temp = "{{ .Params.temp_f }}";
            const fee = "{{ .Params.fee }}";
            
            // Default to next Saturday at 10 AM
            const now = new Date();
            const daysUntilSaturday = (6 - now.getDay() + 7) % 7 || 7;
            const startDate = new Date(now);
            startDate.setDate(now.getDate() + daysUntilSaturday);
            startDate.setHours(10, 0, 0, 0);
            
            const endDate = new Date(startDate);
            endDate.setHours(13, 0, 0, 0); // 3-hour soak
            
            // Format dates for iCal (YYYYMMDDTHHMMSS)
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Washington Hot Springs//EN',
                'BEGIN:VEVENT',
                `UID:${Date.now()}@washingtonhotsprings.com`,
                `DTSTAMP:${formatDate(new Date())}`,
                `DTSTART:${formatDate(startDate)}`,
                `DTEND:${formatDate(endDate)}`,
                `SUMMARY:${springName} Visit`,
                `DESCRIPTION:Temperature: ${temp}¬∞F\\nFee: $${fee}\\n${description}\\n\\nGPS: ${gps}`,
                `LOCATION:${gps}`,
                'STATUS:TENTATIVE',
                'BEGIN:VALARM',
                'TRIGGER:-PT24H',
                'DESCRIPTION:Pack for hot springs tomorrow!',
                'ACTION:DISPLAY',
                'END:VALARM',
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');
            
            // Create download
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${springName.replace(/\s+/g, '-').toLowerCase()}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('üìÖ Calendar event created! Check your downloads folder.');
        }

        // Report Status Form
        function reportStatus() {
            const springName = "{{ .Params.name }} Hot Springs";
            const springSlug = "{{ .Slug }}";
            
            // Create a simple form using Tally (free form service)
            // You can replace this with your preferred form service
            const formURL = `https://tally.so/r/wMRq4v?spring=${encodeURIComponent(springName)}&slug=${springSlug}`;
            
            // Open in new window
            window.open(formURL, '_blank', 'width=600,height=800');
            
            // Alternative: Use a simple prompt for now
            // const feedback = prompt(`Report conditions for ${springName}:\n\nPlease describe current conditions, crowd level, or any issues:`);
            // if (feedback) {
            //     alert('Thank you! Your report has been noted. We will review and update the listing.');
            //     // In production, you'd send this to a backend or form service
            // }
        }

        // GPS copy function
        function copyGPS() {
            navigator.clipboard.writeText('{{ .Params.gps }}').then(() => {
                const btn = document.querySelector('.gps-copy');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                alert('GPS coordinates: {{ .Params.gps }}');
            });
        }
    </script>
</body>
</html>