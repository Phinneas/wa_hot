<!doctype html>
<html>
<head>
    <title>{{ .Title }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        #map { height: 400px; width: 100%; margin: 20px 0; border-radius: 8px; }
        .spring-header { background: linear-gradient(135deg, #e8f4f8, #f0f8ff); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .spring-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f9f9f9; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #007acc; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        .directions-section { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .directions-btn { background: #007acc; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; text-decoration: none; display: inline-block; }
        .directions-btn:hover { background: #005a99; }
        .distance-display { background: #d4edda; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .back-link { color: #007acc; text-decoration: none; margin-bottom: 20px; display: inline-block; }
        .back-link:hover { text-decoration: underline; }
        .widget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .widget-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007acc; }
        .widget-card h4 { margin-top: 0; color: #007acc; }
        .weather-current { font-size: 1.2em; font-weight: bold; margin: 10px 0; }
        .pack-list { list-style: none; padding: 0; }
        .pack-list li { padding: 5px 0; }
        .pack-list li:before { content: "‚úì "; color: #28a745; font-weight: bold; }
        .sun-times { display: flex; justify-content: space-between; margin: 10px 0; }
        .gps-copy { background: #6c757d; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .gps-copy:hover { background: #5a6268; }
    </style>
</head>
<body>
    <a href="/springs/" class="back-link">‚Üê Back to All Hot Springs</a>
    
    <div class="spring-header">
        <h1>{{ .Params.name }} Hot Springs</h1>
        <p>{{ .Params.description }}</p>
    </div>

    <div class="spring-stats">
        <div class="stat-box">
            <div class="stat-value">{{ .Params.temp_f }}¬∞F</div>
            <div class="stat-label">Temperature</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${{ .Params.fee }}</div>
            <div class="stat-label">Entry Fee</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="distance-value">-</div>
            <div class="stat-label">Distance from You</div>
        </div>
    </div>

    <div class="directions-section">
        <h3>üöó Get Directions</h3>
        <button class="directions-btn" onclick="getMyLocationForDirections()">üìç Use My Current Location</button>
        <button class="directions-btn" onclick="showAddressInput()">üìç Enter Starting Address</button>
        
        <div id="address-input-section" style="display: none; margin-top: 15px;">
            <input type="text" id="start-address" placeholder="Enter your starting address or city" style="padding: 10px; width: 300px; margin-right: 10px;">
            <button class="directions-btn" onclick="calculateDirections()">Get Directions</button>
        </div>
        
        <div id="distance-info" class="distance-display" style="display: none;">
            <strong>Distance:</strong> <span id="calculated-distance">-</span> miles
            <br><strong>Estimated Drive Time:</strong> <span id="drive-time">-</span>
        </div>
        
        <div id="directions-links" style="margin-top: 15px; display: none;">
            <a id="google-maps-link" class="directions-btn" target="_blank">üó∫Ô∏è Open in Google Maps</a>
            <a id="apple-maps-link" class="directions-btn" target="_blank">üçé Open in Apple Maps</a>
            <a id="waze-link" class="directions-btn" target="_blank">üöó Open in Waze</a>
        </div>
    </div>

    <div class="widget-grid">
        <div class="widget-card">
            <h4>üå§Ô∏è Current Weather</h4>
            <div id="weather-card">Loading weather...</div>
            <div id="sun-times" class="sun-times">
                <span id="sunrise">üåÖ Loading...</span>
                <span id="sunset">üåá Loading...</span>
            </div>
        </div>
        
        <div class="widget-card">
            <h4>üéí What to Pack</h4>
            <ul id="pack-list" class="pack-list">
                <li>Loading recommendations...</li>
            </ul>
            <div id="crowd-estimate" style="margin-top: 15px; font-style: italic;"></div>
        </div>
    </div>

    <h3>üìç Location & Map</h3>
    <div id="map"></div>
    <p><strong>GPS Coordinates:</strong> {{ .Params.gps }} 
        <button class="gps-copy" onclick="copyGPS()">üìã Copy GPS</button>
    </p>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Parse GPS coordinates
        const gpsString = "{{ .Params.gps }}";
        const coords = gpsString.match(/([\d.]+)¬∞\s*N,\s*([\d.]+)¬∞\s*W/);
        let springLat, springLng;
        let userLocation = null;
        
        if (coords) {
            springLat = parseFloat(coords[1]);
            springLng = -parseFloat(coords[2]); // West is negative
            
            // Create map
            const map = L.map('map').setView([springLat, springLng], 13);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add marker for hot spring
            L.marker([springLat, springLng])
                .addTo(map)
                .bindPopup('<b>{{ .Params.name }} Hot Springs</b><br>{{ .Params.temp_f }}¬∞F - ${{ .Params.fee }}')
                .openPopup();
        }

        function getMyLocationForDirections() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        calculateAndDisplayDirections();
                    },
                    (error) => {
                        alert('Could not get your location. Please try entering your address instead.');
                    }
                );
            } else {
                alert('Geolocation not supported by your browser.');
            }
        }

        function showAddressInput() {
            document.getElementById('address-input-section').style.display = 'block';
        }

        function calculateDirections() {
            const address = document.getElementById('start-address').value;
            if (!address) {
                alert('Please enter a starting address.');
                return;
            }

            // Geocode the address
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        userLocation = {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon)
                        };
                        
                        calculateAndDisplayDirections();
                    } else {
                        alert('Address not found. Please try a different address.');
                    }
                })
                .catch(error => {
                    alert('Error looking up address.');
                });
        }

        function calculateAndDisplayDirections() {
            if (!userLocation || !springLat || !springLng) return;

            // Calculate distance
            const distance = calculateDistance(userLocation.lat, userLocation.lng, springLat, springLng);
            
            // Estimate drive time (assuming average 45 mph including stops)
            const driveTimeHours = distance / 45;
            const hours = Math.floor(driveTimeHours);
            const minutes = Math.round((driveTimeHours - hours) * 60);
            const driveTimeText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            // Update display
            document.getElementById('calculated-distance').textContent = distance.toFixed(1);
            document.getElementById('drive-time').textContent = driveTimeText;
            document.getElementById('distance-value').textContent = distance.toFixed(1) + ' mi';
            document.getElementById('distance-info').style.display = 'block';
            document.getElementById('directions-links').style.display = 'block';

            // Update direction links
            const googleUrl = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lng}/${springLat},${springLng}`;
            const appleUrl = `http://maps.apple.com/?saddr=${userLocation.lat},${userLocation.lng}&daddr=${springLat},${springLng}`;
            const wazeUrl = `https://waze.com/ul?ll=${springLat},${springLng}&navigate=yes&from=${userLocation.lat},${userLocation.lng}`;

            document.getElementById('google-maps-link').href = googleUrl;
            document.getElementById('apple-maps-link').href = appleUrl;
            document.getElementById('waze-link').href = wazeUrl;

            // Add user location to map
            if (window.map) {
                const userMarker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo=',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(window.map);

                userMarker.bindPopup('<b>üìç Your Location</b>');

                // Fit map to show both locations
                const group = new L.featureGroup([
                    L.marker([springLat, springLng]),
                    userMarker
                ]);
                window.map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Store map reference globally
        if (coords) {
            window.map = map;
            
            // Load weather and other widgets
            loadWeather(springLat, springLng);
            loadSunTimes(springLat, springLng);
            generatePackingList();
            estimateCrowd();
        }

        // Weather widget
        function loadWeather(lat, lng) {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,precipitation,weather_code,wind_speed_10m&temperature_unit=fahrenheit&timezone=auto`)
                .then(r => r.json())
                .then(d => {
                    const temp = Math.round(d.current.temperature_2m);
                    const precip = d.current.precipitation;
                    const wind = Math.round(d.current.wind_speed_10m);
                    const weatherCode = d.current.weather_code;
                    
                    // Simple weather code interpretation
                    let condition = 'Clear';
                    if (weatherCode >= 80) condition = 'Rainy';
                    else if (weatherCode >= 61) condition = 'Light Rain';
                    else if (weatherCode >= 51) condition = 'Drizzle';
                    else if (weatherCode >= 45) condition = 'Foggy';
                    else if (weatherCode >= 20) condition = 'Cloudy';
                    
                    document.getElementById('weather-card').innerHTML = `
                        <div class="weather-current">${temp}¬∞F - ${condition}</div>
                        <div>üí® Wind: ${wind} mph | üåßÔ∏è Precip: ${precip}" today</div>
                    `;
                })
                .catch(() => {
                    document.getElementById('weather-card').innerHTML = 'Weather unavailable';
                });
        }

        // Sunrise/sunset widget
        function loadSunTimes(lat, lng) {
            fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`)
                .then(r => r.json())
                .then(d => {
                    const sunrise = new Date(d.results.sunrise).toLocaleTimeString([], {timeStyle: 'short'});
                    const sunset = new Date(d.results.sunset).toLocaleTimeString([], {timeStyle: 'short'});
                    
                    document.getElementById('sunrise').textContent = `üåÖ ${sunrise}`;
                    document.getElementById('sunset').textContent = `üåá ${sunset}`;
                })
                .catch(() => {
                    document.getElementById('sunrise').textContent = 'üåÖ Sunrise: --';
                    document.getElementById('sunset').textContent = 'üåá Sunset: --';
                });
        }

        // Smart packing list based on season and conditions
        function generatePackingList() {
            const month = new Date().getMonth() + 1;
            const isWinter = month <= 3 || month >= 11;
            const isSummer = month >= 6 && month <= 8;
            
            let packItems = ['Swimsuit', 'Towel', 'Water bottle', 'Snacks'];
            
            if (isWinter) {
                packItems.push('Warm clothes', 'Waterproof boots', 'Hand warmers');
            } else if (isSummer) {
                packItems.push('Sunscreen', 'Hat', 'Sandals');
            } else {
                packItems.push('Light jacket', 'Comfortable shoes');
            }
            
            // Add fee-specific items
            if ({{ .Params.fee }} > 0) {
                packItems.push('Cash for entry fee');
            }
            
            document.getElementById('pack-list').innerHTML = packItems.map(item => `<li>${item}</li>`).join('');
        }

        // Crowd estimation
        function estimateCrowd() {
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday
            const hour = now.getHours();
            const isWeekend = (day === 0 || day === 6);
            const isFree = {{ .Params.fee }} === 0;
            
            let crowdLevel = 'Quiet';
            let crowdColor = '#28a745';
            
            if (isWeekend && isFree) {
                crowdLevel = 'Likely Busy';
                crowdColor = '#ffc107';
            } else if (isWeekend || (hour >= 10 && hour <= 16)) {
                crowdLevel = 'Moderate';
                crowdColor = '#17a2b8';
            }
            
            document.getElementById('crowd-estimate').innerHTML = `
                <span style="color: ${crowdColor};">üìä Expected crowd: ${crowdLevel}</span>
            `;
        }

        // GPS copy function
        function copyGPS() {
            navigator.clipboard.writeText('{{ .Params.gps }}').then(() => {
                const btn = document.querySelector('.gps-copy');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                alert('GPS coordinates: {{ .Params.gps }}');
            });
        }
    </script>
</body>
</html>